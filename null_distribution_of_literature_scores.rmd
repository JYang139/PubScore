
# Testing the PubScore - P-value by simulation

How can we know if the list of genes that a method spat to us is actually meaningful? 

Let's explore how to calculate a literature score for selected genes, 
and estimate the likelihood of such a score (or higher) happening by chance. 

We will use the scDengue dataset from the FCBF package and look if the FCBF
selected genes are already related in the literature to dengue. 

```{r Prepare the data}
devtools::install_github('lubianat/PubScore')
library(PubScore)
library(FCBF)
library(progress)

data("scDengue")
exprs <- as.data.frame(SummarizedExperiment::assay(scDengue,'logcounts'))
discrete_expression <- as.data.frame(discretize_exprs(exprs))

infection <- SummarizedExperiment::colData(scDengue)
target <- infection$infection
fcbf_features <- fcbf(discrete_expression, target, thresh = 0.05, verbose = TRUE)

total_genes <- rownames(exprs)
#
```



We run FCBF on the scDengue dataset as in FCBF 1.0.1 vignette. 
The scDengue dataset is with Ensemble IDs, and usually papers use gene symbols. 
Using biomaRt we can change it.

```{r}
library(biomaRt)

ensembl = useMart("ensembl",dataset="hsapiens_gene_ensembl")
reference = biomaRt::getBM(attributes = c('ensembl_gene_id', 'hgnc_symbol'), 
              mart = ensembl)

total_genes <- reference[reference$ensembl_gene_id %in% total_genes,]$hgnc_symbol

fcbf_genes<- reference[reference$ensembl_gene_id %in% rownames(fcbf_features),]$hgnc_symbol
```




Now we will run PubScore for all combinations of genes in the dataset + the term "Dengue"



```{r}
terms_of_interest <- 'Dengue'
# 
set.seed(2018)

simulation_of_literature_null <- data.frame(2,2,2)
simulation_of_literature_null <- simulation_of_literature_null[-1,]
pb <- progress::progress_bar$new(format = "[:bar] :current/:total (:percent) ETA: :eta", total = length(total_genes))
#getting scores for all genes it can before tomorrow morning

for (i in total_genes){
  pb$tick()
  tryCatch({
   ps_object <- PubScore::get_literature_score(i, terms_of_interest, show_progress = F)
   new_line <- data.frame(i, ps_object$counts)
   simulation_of_literature_null <- rbind(simulation_of_literature_null, new_line)
   Sys.sleep(0.2)}, error = function(e){print(e)
  })
  
simulation_of_literature_null <- simulation_of_literature_null[simulation_of_literature_null$i != "",]  
   
}

simulation_of_literature_null <- readRDS('data/PubScoreDB_May_2019.rds')
simulation_of_literature_null<- simulation_of_literature_null[simulation_of_literature_null$Var2=='Dengue', ]

```
Hooray, after 5 hours we have the reference table. Let's make some simulations. s 


```{r}
genes_to_sample <- length(fcbf_genes[fcbf_genes != ""])
distribution_of_scores <- c()
pb2 <- progress::progress_bar$new(format = "[:bar] :current/:total (:percent) ETA: :eta", total = 100000)
for (i in 1:100000){
        genes_to_sample_now <- sample(total_genes, genes_to_sample)
        simu_now <- simulation_of_literature_null[simulation_of_literature_null$Var1 %in% genes_to_sample_now,]$count
        list_score <- sum(simu_now) / genes_to_sample
        distribution_of_scores <- c(distribution_of_scores,list_score )
  pb2$tick()
  list_score <- mean(sample(simulation_of_literature_null$count, genes_to_sample))
  distribution_of_scores <- c(distribution_of_scores,list_score )
  
}
distribution_of_scores_no_outliers <- data.frame(d =  distribution_of_scores[distribution_of_scores<1000])
distribution_of_scores<- as.data.frame(distribution_of_scores)
```

Okay, let's plot it and compare to the FCBF_features score


```{r}
MAX_SCORE = max(distribution_of_scores)
MIN_SCORE = min(distribution_of_scores)
library(ggplot2)
ggplot(distribution_of_scores_no_outliers, aes(x = d))+
  geom_density() +
  ggtitle('Density of the distribution of null scores(10^6 resamplings)') +
  xlab('Average number of counts on PubMed') +
  ylab('Proportion of gene-lists for each category')
```

Ok, so, let's see if fcbf-selected features are significantly associated with 'dengue'

```{r}


fcbf_score <- data.frame(2,2,2)
fcbf_score <- fcbf_score[-1,]
pb3 <- progress::progress_bar$new(format = "[:bar] :current/:total (:percent) ETA: :eta", total = length(fcbf_genes))
#getting scores for all genes it can before tomorrow morning
terms_of_interest = 'Dengue'
for (i in fcbf_genes){
  pb3$tick()
  tryCatch({
   ps_object <- PubScore::get_literature_score(i, terms_of_interest, show_progress = F)
   new_line <- data.frame(i, ps_object$counts)
   fcbf_score <- rbind(fcbf_score, new_line)
   Sys.sleep(0.2)}, error = function(e){print(e)
  })
}
fcbf_score <-fcbf_score[fcbf_score$Var2 == 'Dengue',]
fcbf_score <- fcbf_score[fcbf_score$i != "",]  
   
score <- sum(fcbf_score$count)

print(sum(distribution_of_scores[,1] >= score)/length(distribution_of_scores[,1])) 
```

So the estimated p-value for association between the FCBF-selected genes and 
the term "Dengue" is 0.016 .
